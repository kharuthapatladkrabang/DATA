// *********************************************************************************
// ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ URL ‡∏Ç‡∏≠‡∏á Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà Deploy ‡πÅ‡∏•‡πâ‡∏ß
// *********************************************************************************
const EXTERNAL_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby8fp4aMtkS8xv3VKQ2_5caHf5VvQBzhvYxHXpaAPbT-jGTSqKggfiKJVgqLI74HaNZPA/exec';

// =================================================================
// CORE API FETCHER
// =================================================================

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏Ç‡∏≠‡∏á Apps Script
 * @param {string} action - ‡∏ä‡∏∑‡πà‡∏≠ action ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å ('get_studio_list', 'get_geofence_config', etc.)
 * @param {Object} params - ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô {studio: 'Studio Name'})
 * @returns {Promise<Object>} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å API
 */
async function callAppsScriptAPI(action, params = {}) {
    const url = new URL(EXTERNAL_WEB_APP_URL);
    url.searchParams.set('action', action);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏á‡πÉ‡∏ô URL (‡πÄ‡∏ä‡πà‡∏ô studio name)
    for (const key in params) {
        url.searchParams.set(key, params[key]);
    }

    try {
        // Apps Script API ‡πÉ‡∏ä‡πâ method: 'POST' ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
        const response = await fetch(url.toString(), {
            method: 'POST'
        });

        if (!response.ok) {
            // ‡∏´‡∏≤‡∏Å HTTP Status ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 2xx
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            return response.json();
        } else {
            // ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Permission ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î Apps Script ‡∏°‡∏µ Error
            throw new Error("API response was not valid JSON. Check Apps Script Deployment/Logs.");
        }
    } catch (error) {
        console.error(`Error calling action=${action}:`, error);
        return { success: false, message: error.message };
    }
}

// =================================================================
// WRAPPER FUNCTIONS (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á)
// =================================================================

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏° Studio ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï 'Studio')
 * @returns {Promise<Array<string>>} ‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠ Studio
 */
async function getStudioList() {
    const result = await callAppsScriptAPI('get_studio_list');
    if (result.success) {
        return result.studioNames || [];
    }
    console.error("Failed to get studio list:", result.message);
    return [];
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Configuration ‡∏Ç‡∏≠‡∏á Studio ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ (Geofence, URL, Control)
 * @param {string} studioName - ‡∏ä‡∏∑‡πà‡∏≠ Studio (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï 'Studio')
 * @returns {Promise<Object|null>} Object ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Config ‡∏´‡∏£‡∏∑‡∏≠ null ‡∏ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
 */
async function getStudioConfig(studioName) {
    const result = await callAppsScriptAPI('get_geofence_config', { studio: studioName });
    if (result.success) {
        return result;
    }
    console.error(`Failed to get config for ${studioName}:`, result.message);
    return null;
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Config ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Announcement (H18, K18, L18)
 * @returns {Promise<Object|null>} Object ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Announcement ‡∏´‡∏£‡∏∑‡∏≠ null ‡∏ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
 */
async function getAnnouncementConfig() {
    const result = await callAppsScriptAPI('get_announcement_image');
    if (result.success) {
        return result;
    }
    console.warn("Announcement Config not found or invalid:", result.message);
    return null; // ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á result ‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π message
}

// =================================================================
// üí° ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å
// =================================================================

async function demonstrateDataFetching() {
    // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    console.log("--- 1. Fetching Studio List ---");
    const studioNames = await getStudioList();
    
    if (studioNames.length > 0) {
        console.log("Available Studios:", studioNames);

        // 2. ‡∏î‡∏∂‡∏á Config ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏£‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const firstStudioName = studioNames[0];
        console.log(`\n--- 2. Fetching Config for: ${firstStudioName} ---`);
        const config = await getStudioConfig(firstStudioName);
        console.log(config); 
    } else {
        console.log("No Studio buttons were found.");
    }
    
    // 3. ‡∏î‡∏∂‡∏á Config ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
    console.log("\n--- 3. Fetching Announcement Config ---");
    const announcement = await getAnnouncementConfig();
    console.log(announcement);
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
// demonstrateDataFetching(); // Uncomment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö
